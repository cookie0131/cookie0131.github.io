<!doctype html>



  


<html class="theme-next pisces use-motion">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />












  
  
    
  
  <link href="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.css" rel="stylesheet" type="text/css" />







  

<link href="//cdn.bootcss.com/font-awesome/4.4.0/fonts/fontawesome-webfont.svg" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.0.1" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Flask,Python," />








  <link rel="shortcut icon" type="image/x-icon" href="/images/favicon.ico?v=5.0.1" />






<meta name="description" content="配置Flask-WTF是WTForms项目的Flask框架扩展，我们将用他来帮助我们处理web表单。大部分Flask扩展都需要定义相关配置项，所以我们先来在应用根目录下创建一个配置文件以备使用。我们先这样创建 (fileconfig.py):12CSRF_ENABLED = TrueSECRET_KEY = &amp;apos;you-will-never-guess&amp;apos;">
<meta property="og:type" content="article">
<meta property="og:title" content="Flask：Web表单">
<meta property="og:url" content="http://www.fatiao.site/flask_3.html">
<meta property="og:site_name" content="小发条的技术人生">
<meta property="og:description" content="配置Flask-WTF是WTForms项目的Flask框架扩展，我们将用他来帮助我们处理web表单。大部分Flask扩展都需要定义相关配置项，所以我们先来在应用根目录下创建一个配置文件以备使用。我们先这样创建 (fileconfig.py):12CSRF_ENABLED = TrueSECRET_KEY = &amp;apos;you-will-never-guess&amp;apos;">
<meta property="og:updated_time" content="2016-10-04T16:11:20.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Flask：Web表单">
<meta name="twitter:description" content="配置Flask-WTF是WTForms项目的Flask框架扩展，我们将用他来帮助我们处理web表单。大部分Flask扩展都需要定义相关配置项，所以我们先来在应用根目录下创建一个配置文件以备使用。我们先这样创建 (fileconfig.py):12CSRF_ENABLED = TrueSECRET_KEY = &amp;apos;you-will-never-guess&amp;apos;">



<script type="text/javascript" id="hexo.configuration">
  var NexT = window.NexT || {};
  var CONFIG = {
    scheme: 'Pisces',
    sidebar: {"position":"left","display":"post"},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: 0,
      author: '博主'
    }
  };
</script>




  <link rel="canonical" href="http://www.fatiao.site/flask_3.html"/>

  <meta name="baidu-site-verification" content="K7iVtNDL7l" />
  <title> Flask,Python, - Flask：Web表单 | 小发条的技术人生 </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  





  <script type="text/javascript">
    (function() {
      var hm = document.createElement("script");
      hm.src = "//tajs.qq.com/stats?sId=58555379";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>






  
  
    
  

  <div class="container one-collumn sidebar-position-left page-post-detail ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-meta ">
  

  <div class="custom-logo-site-title">
    <a href="/"  class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">小发条的技术人生</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
  <p class="site-subtitle">测试攻城狮 pythoner 伪程序猿一枚</p>
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      

      
    </ul>
  

  
</nav>

 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                Flask：Web表单
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2013-06-18T00:00:00+08:00" content="2013-06-18">
              2013-06-18
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/Python/" itemprop="url" rel="index">
                    <span itemprop="name">Python</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/flask_3.html#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="flask_3.html" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        <h2 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h2><p>Flask-WTF是WTForms项目的Flask框架扩展，我们将用他来帮助我们处理web表单。<br>大部分Flask扩展都需要定义相关配置项，所以我们先来在应用根目录下创建一个配置文件以备使用。我们先这样创建 (fileconfig.py):<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">CSRF_ENABLED = True</div><div class="line">SECRET_KEY = &apos;you-will-never-guess&apos;</div></pre></td></tr></table></figure></p>
<a id="more"></a>
<p>很简单吧，这是Flask-WTF需要用到的2个配置项。CSRF_ENABLED配置启用了跨站请求攻击保护，大部分情况下你都需要开启此功能，这能使你的应用更安全。</p>
<p>SECRET_KEY设置当CSRF启用时有效，这将生成一个加密的token供表单验证使用，你要确保这个KEY足够复杂不会被简单推测。<br>现在这个配置文件已经基本可用了。项目创建完成我们可以创建如下文件并编辑(fileapp/<strong>init</strong>.py):<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">import Flask</div><div class="line"> </div><div class="line">app = Flask(__name__)</div><div class="line">app.config.from_object(&apos;config&apos;)</div><div class="line"> </div><div class="line">from app import views</div></pre></td></tr></table></figure></p>
<h2 id="用户登录表单"><a href="#用户登录表单" class="headerlink" title="用户登录表单"></a>用户登录表单</h2><p>使用Flask-WTF创建的表单就像一个对象，需要从Form类继承子类。然后在这个子类中定义一些类的属性变量作为表单字段就可以了。<br>我们要创建一个登录表单，用来进行用户身份识别。但跟平常需要验证用户名和密码的登录方式不同，我们将使用 OpenId 来处理登录过程。使用OpenId的好处就是我们不用管那些用户名和密码的认证过程，交给 OpenId 去搞定，它会返回给我们用户验证后的数据。这样对于使用我们网站的用户而言也更安全。</p>
<p>使用 OpenId 登录只需要一个字符串，然后发送给 OpenId 服务器就行了。另外我们还需要在表单中加一个“记住我” 的选项框，这个是送给那些不想每次来我们网站都要进行身份认证的人。选择这个选项后，首次登录时会用cookie在他们的浏览器上记住他们的登录信息，下次再进入网站时就不需要进行登录操作。<br>开始我们的第一个表单吧 （fileapp/forms.py):<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">from flask.ext.wtf import Form, TextField, BooleanField</div><div class="line">from flask.ext.wtf import Required</div><div class="line"> </div><div class="line">class LoginForm(Form):</div><div class="line">    openid = TextField(&apos;openid&apos;, validators = [Required()])</div><div class="line">    remember_me = BooleanField(&apos;remember_me&apos;, default = False)</div></pre></td></tr></table></figure></p>
<p>欣赏一下这个类，多么的简洁，多么的一目了然。如此简单，但又十分的富有内涵。我们引入了一个 Form 类，然后继承这个类，按需求还添加了 TextField 和 BooleanField 这两个字段。<br>另外还引入了一个表单验证函数 Required，这种验证函数可以附加在字段里面，在用户提交表单时它们会用来检查用户填写的数据。这个 Required 函数是用来防止用户提交空数据。Flask-WTF 中还有很多不同作用的表单验证函数，我们将会在后面使用到它们。</p>
<h2 id="表单模板"><a href="#表单模板" class="headerlink" title="表单模板"></a>表单模板</h2><p>现在我们的问题就是需要一个显示这个登录表单的模板。好消息是我们刚刚创建的登录表单类知道如何把字段转换成HTML，所以我们只需要把注意力集中到页面布局上。下面就是我们的登录表单的模板 (fileapp/templates/login.html):<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">&lt;!-- extend from base layout --&gt;</div><div class="line">&#123;% extends &quot;base.html&quot; %&#125;</div><div class="line"> </div><div class="line">&#123;% block content %&#125;</div><div class="line">&lt;h1&gt;Sign In&lt;/h1&gt;</div><div class="line">&lt;form action=&quot;&quot; method=&quot;post&quot; name=&quot;login&quot;&gt;</div><div class="line">    &#123;&#123;form.hidden_tag()&#125;&#125;</div><div class="line">    &lt;p&gt;</div><div class="line">        Please enter your OpenID:&lt;br&gt;</div><div class="line">        &#123;&#123;form.openid(size=80)&#125;&#125;&lt;br&gt;</div><div class="line">    &lt;/p&gt;</div><div class="line">    &lt;p&gt;&#123;&#123;form.remember_me&#125;&#125; Remember Me&lt;/p&gt;</div><div class="line">    &lt;p&gt;&lt;input type=&quot;submit&quot; value=&quot;Sign In&quot;&gt;&lt;/p&gt;</div><div class="line">&lt;/form&gt;</div><div class="line">&#123;% endblock %&#125;</div></pre></td></tr></table></figure></p>
<p>容我啰嗦一下，在这个模板中，我们又一次使用了模板继承的方式。使用 extends 语句从 base.html 继承模板内容。我们会在后面创建的模板中继续使用这种方式，这样可以使我们所有的页面布局保持一致。</p>
<p>这个登录模板跟普通的HTML表单有些明显的区别，它使用模板参数/{ { … } }<br> 来实例化表单字段，而表单字段又来源于我们刚刚定义的表单类，模板参数中使用了 form 这个名称。当我们使用视图函数引用表单类并渲染到模板时，我们要特别注意这个把表单类传递到模板的变量名。<br>我们在配置中开启了CSRF(跨站伪造请求)功能，模板参数 { { form.hidden_tag() } } 会被替换成一个具有防止CSRF功能的隐藏表单字段。在开启了CSRF功能后，所有模板的表单中都需要添加这个模板参数。</p>
<p>我们定义的表单对象中的字段同样也能被模板渲染，只需要在模板合适的位置添加类似于  这样的模板参数，相关字段就会在被定义的位置出现。另外还有一些字段是可以传参数，比如这个 openid 字段，我们就添加了一个参数让它显示的宽度增加到80个字符。<br>由于我们没有在表单中定义一个提交功能的按钮，所以在这里只能以普通表单字段的方式来做了。不过说起来区区一个按钮，在表单中跟任何数据都没有关系，的确也没有在表单类中定义的必要。</p>
<h2 id="表单视图"><a href="#表单视图" class="headerlink" title="表单视图"></a>表单视图</h2><p>见证奇迹的时刻最后一步，我们马上要来写一个渲染登录表单对象到模板的视图函数。<br>这个函数相当的简单无趣，因为我们只需要把表单对象传递给模板就行了。下面就是我们这个视图函数的全部内容 (fileapp/views.py)：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">from flask import render_template, flash, redirect</div><div class="line">from app import app</div><div class="line">from forms import LoginForm</div><div class="line"> </div><div class="line"># index view function suppressed for brevity</div><div class="line"> </div><div class="line">@app.route(&apos;/login&apos;, methods = [&apos;GET&apos;, &apos;POST&apos;])</div><div class="line">def login():</div><div class="line">    form = LoginForm()</div><div class="line">    return render_template(&apos;login.html&apos;,</div><div class="line">        title = &apos;Sign In&apos;,</div><div class="line">        form = form)</div></pre></td></tr></table></figure></p>
<p>我们引入登录表单类，然后把它实例化到一个变量，最后再把这个变量传给模板。要渲染表单字段必须的事情也就这些。<br>上面的代码中还引入了两个新对象： falsh 和 redirect, 这个先甭理它们，稍后才用得上。</p>
<p>另外还做了一件事就是在路由装饰器中添加一个新方法。让 Flask 明白我们这个视图函数支持 GET 和 POST 请求。否则这个视图函数只会响应 GET 请求。我们需要得到用户填写表单后提交的数据，这些数据是从 POST 请求中传递过来的。<br>你可以通过在浏览器中测试这个程序来了解上面所说的。 按照视图函数关联的路由，你应该在浏览器中输入 <a href="http://localhost:5000/login" target="_blank" rel="external">http://localhost:5000/login</a><br>由于我们还没有写任何接收数据的代码，所以现在你在页面中点提交按钮还没有任何效果</p>
<h2 id="从表单中接收数据"><a href="#从表单中接收数据" class="headerlink" title="从表单中接收数据"></a>从表单中接收数据</h2><p>另外值得一提的是， Flask-WTF 对表单提交数据的处理使我们的接下来要做的事情变得简单了。下面就是我们这个登录视图函数的新版本, 加入了表单数据验证和处理 (fileapp/views.py):<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">@app.route(&apos;/login&apos;, methods = [&apos;GET&apos;, &apos;POST&apos;])</div><div class="line">def login():</div><div class="line">    form = LoginForm()</div><div class="line">    if form.validate_on_submit():</div><div class="line">        flash(&apos;Login requested for OpenID=&quot;&apos; + form.openid.data + &apos;&quot;, remember_me=&apos; + str(form.remember_me.data))</div><div class="line">        return redirect(&apos;/index&apos;)</div><div class="line">    return render_template(&apos;login.html&apos;,</div><div class="line">        title = &apos;Sign In&apos;,</div><div class="line">        form = form)</div></pre></td></tr></table></figure></p>
<p>validate_on_submit() 这个方法做了表单处理的所有工作。如果你在表单向用户提供数据时(举个栗子：用户在它之前修改了一下提交的数据) 时调用此方法，它会返回 False。发生这样的情况时，你懂的。不懂？就是提交的数据验证不通过，你要继续渲染模板。</p>
<p>在提交请求时调用了表单的 validate_on_submit() 方法后，它会从请求中获取所有提交的数据，然后使用表单字段中绑定的验证函数进行数据验证。在所有的数据都验证通过时会返回 True. 这就意味着你可以放心的使用这些表单数据了。<br>只要有一个字段验证不通过，它都会返回 False. 这时就需要我们返回数据给用户，让他们来纠正一下错误数据。接下来我们将会看到在数据验证失败时，如何把错误消息显示给用户。</p>
<p>当 validate_on_submit() 方法返回 True 的时候，我们的视图函数又会调用两个新的函数。它们都是从Flask 中引入的，flash 函数用来在下一个打开的页面中显示定义的消息。我们现在用它用来做调试。因为我们现在还没有做用户登录模块， 所以只需要把用户提交上来的数据显示一下就行了。flash 函数非常有用，比如为用户的一些操作提供消息反馈。<br>flash 函数提供的消息不会自动出现在我们的网站页面中，所以我们需要做点事情让它在页面中显示出来。为了让我们所有页面都能有这项激动人心的功能，所以就把它添加到基础模板中吧, 下面是更新后的基础模板 (fileapp/templates/base.html):<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line">&lt;html&gt;</div><div class="line">  &lt;head&gt;</div><div class="line">    &#123;% if title %&#125;</div><div class="line">    &lt;title&gt;&#123;&#123;title&#125;&#125; - microblog&lt;/title&gt;</div><div class="line">    &#123;% else %&#125;</div><div class="line">    &lt;title&gt;microblog&lt;/title&gt;</div><div class="line">    &#123;% endif %&#125;</div><div class="line">  &lt;/head&gt;</div><div class="line">  &lt;body&gt;</div><div class="line">    &lt;div&gt;Microblog: &lt;a href=&quot;/index&quot;&gt;Home&lt;/a&gt;&lt;/div&gt;</div><div class="line">    &lt;hr&gt;</div><div class="line">    &#123;% with messages = get_flashed_messages() %&#125;</div><div class="line">    &#123;% if messages %&#125;</div><div class="line">    &lt;ul&gt;</div><div class="line">    &#123;% for message in messages %&#125;</div><div class="line">        &lt;li&gt;&#123;&#123; message &#125;&#125; &lt;/li&gt;</div><div class="line">    &#123;% endfor %&#125;</div><div class="line">    &lt;/ul&gt;</div><div class="line">    &#123;% endif %&#125;</div><div class="line">    &#123;% endwith %&#125;</div><div class="line">    &#123;% block content %&#125;&#123;% endblock %&#125;</div><div class="line">  &lt;/body&gt;</div><div class="line">&lt;/html&gt;</div></pre></td></tr></table></figure></p>
<p>模板中显示 flash 消息的功能希望你能明白。</p>
<p>在视图函数中我们使用的另一个新函数就是 redirect. 这个函数会通知用户的浏览器跳转到指定的地址。在我们的视图函数中，我们使用它跳转到了首页。注意跳转结束后页面上还会显示 flash 函数传递的消息哦。<br>激动人心的时刻到了，运行我们的程序吧，看看表单是如何工作的吧。不要填写表单中的 openid 字段，看看 Required 这个验证函数是如何发挥威力，把一切发起空数据的请求阻止在千里之外。</p>
<h2 id="改善一下字段验证"><a href="#改善一下字段验证" class="headerlink" title="改善一下字段验证"></a>改善一下字段验证</h2><p>我们程序目前状况不错，提交不合要求的数据会被阻止，还会返回表单让用户修改，基本满足我们要求。<br>但似乎还少点什么。如果我们在用户提交数据失败后给用户点提示，让他们知道什么原因引起的，岂不妙哉！太幸运了，用 Flask-WTF 可以轻松解决这个问题。<br>当表单字段验证失败时， Flask-WTF 会添加一个错误消息到表单对象。这些消息在模板中也是可以使用的，所以我们只需要在模板中添加一点点东西就OK了。</p>
<p>这个就是我们添加了验证消息的登录模板 (fileapp/templates/login.html):<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">&lt;!-- extend base layout --&gt;</div><div class="line">&#123;% extends &quot;base.html&quot; %&#125;</div><div class="line"> </div><div class="line">&#123;% block content %&#125;</div><div class="line">&lt;h1&gt;Sign In&lt;/h1&gt;</div><div class="line">&lt;form action=&quot;&quot; method=&quot;post&quot; name=&quot;login&quot;&gt;</div><div class="line">    &#123;&#123;form.hidden_tag()&#125;&#125;</div><div class="line">    &lt;p&gt;</div><div class="line">        Please enter your OpenID:&lt;br&gt;</div><div class="line">        &#123;&#123;form.openid(size=80)&#125;&#125;&lt;br&gt;</div><div class="line">        &#123;% for error in form.errors.openid %&#125;</div><div class="line">        &lt;span style=&quot;color: red;&quot;&gt;[&#123;&#123;error&#125;&#125;]&lt;/span&gt;</div><div class="line">        &#123;% endfor %&#125;&lt;br&gt;</div><div class="line">    &lt;/p&gt;</div><div class="line">    &lt;p&gt;&#123;&#123;form.remember_me&#125;&#125; Remember Me&lt;/p&gt;</div><div class="line">    &lt;p&gt;&lt;input type=&quot;submit&quot; value=&quot;Sign In&quot;&gt;&lt;/p&gt;</div><div class="line">&lt;/form&gt;</div><div class="line">&#123;% endblock %&#125;</div></pre></td></tr></table></figure></p>
<p>我们仅在 openid 字段的右边添加了一个循环语句，它会把openid字段验证失败的消息都显示出来。不论你的表单有多少字段，所有表单字段验证失败的错误消息都可以用 form.errors.字段名 这种方式来使用。这个表单中我们的是 form.errors.openid。为了让错误消息引起用户的注意，我们还给消息添加了显示红色的 css 样式。</p>
<h2 id="处理-OpenID-登录"><a href="#处理-OpenID-登录" class="headerlink" title="处理 OpenID 登录"></a>处理 OpenID 登录</h2><p>现实生活中，我们发现有很多人都不知道他们拥有一些公共账号。一部分大牌的网站或服务商都会为他们的会员提供公共账号的认证。举个栗子，如果你有一个 google 账号，其实你就有了一个公共账号，类似的还有 Yahoo, AOL, Flickr 等。<br>为了方便我们的用户能简单的使用他们的公共账号，我们将把这些公共账号的链接添加到一个列表，这样用户就不用自手工输入了。</p>
<p>我们要把一些提供给用户的公共账号服务商定义到一个列表里面，这个列表就放到配置文件中吧 (fileconfig.py):<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">CSRF_ENABLED = True</div><div class="line">SECRET_KEY = &apos;you-will-never-guess&apos;</div><div class="line"> </div><div class="line">OPENID_PROVIDERS = [</div><div class="line">    &#123; &apos;name&apos;: &apos;Google&apos;, &apos;url&apos;: &apos;https://www.google.com/accounts/o8/id&apos; &#125;,</div><div class="line">    &#123; &apos;name&apos;: &apos;Yahoo&apos;, &apos;url&apos;: &apos;https://me.yahoo.com&apos; &#125;,</div><div class="line">    &#123; &apos;name&apos;: &apos;AOL&apos;, &apos;url&apos;: &apos;http://openid.aol.com/&lt;username&gt;&apos; &#125;,</div><div class="line">    &#123; &apos;name&apos;: &apos;Flickr&apos;, &apos;url&apos;: &apos;http://www.flickr.com/&lt;username&gt;&apos; &#125;,</div><div class="line">    &#123; &apos;name&apos;: &apos;MyOpenID&apos;, &apos;url&apos;: &apos;https://www.myopenid.com&apos; &#125;]</div></pre></td></tr></table></figure></p>
<p>接下来就是要在我们的登录视图函数中使用这个列表了:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">@app.route(&apos;/login&apos;, methods = [&apos;GET&apos;, &apos;POST&apos;])</div><div class="line">def login():</div><div class="line">    form = LoginForm()</div><div class="line">    if form.validate_on_submit():</div><div class="line">        flash(&apos;Login requested for OpenID=&quot;&apos; + form.openid.data + &apos;&quot;, remember_me=&apos; + str(form.remember_me.data))</div><div class="line">        return redirect(&apos;/index&apos;)</div><div class="line">    return render_template(&apos;login.html&apos;,</div><div class="line">        title = &apos;Sign In&apos;,</div><div class="line">        form = form,</div><div class="line">        providers = app.config[&apos;OPENID_PROVIDERS&apos;])</div></pre></td></tr></table></figure></p>
<p>我们从 app.config 中引入了公共账号服务商的配置列表，然后把它作为一个参数通过 render_template 函数引入到模板。</p>
<p>接下来要做的我想你也猜得到，我们需要在登录模板中把这些服务商链接显示出来。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div></pre></td><td class="code"><pre><div class="line">&lt;!-- extend base layout --&gt;</div><div class="line">&#123;% extends &quot;base.html&quot; %&#125;</div><div class="line"> </div><div class="line">&#123;% block content %&#125;</div><div class="line">&lt;script type=&quot;text/javascript&quot;&gt;</div><div class="line">function set_openid(openid, pr)</div><div class="line">&#123;</div><div class="line">    u = openid.search(&apos;&lt;username&gt;&apos;)</div><div class="line">    if (u != -1) &#123;</div><div class="line">        // openid requires username</div><div class="line">        user = prompt(&apos;Enter your &apos; + pr + &apos; username:&apos;)</div><div class="line">        openid = openid.substr(0, u) + user</div><div class="line">    &#125;</div><div class="line">    form = document.forms[&apos;login&apos;];</div><div class="line">    form.elements[&apos;openid&apos;].value = openid</div><div class="line">&#125;</div><div class="line">&lt;/script&gt;</div><div class="line">&lt;h1&gt;Sign In&lt;/h1&gt;</div><div class="line">&lt;form action=&quot;&quot; method=&quot;post&quot; name=&quot;login&quot;&gt;</div><div class="line">    &#123;&#123;form.hidden_tag()&#125;&#125;</div><div class="line">    &lt;p&gt;</div><div class="line">        Please enter your OpenID, or select one of the providers below:&lt;br&gt;</div><div class="line">        &#123;&#123;form.openid(size=80)&#125;&#125;</div><div class="line">        &#123;% for error in form.errors.openid %&#125;</div><div class="line">        &lt;span style=&quot;color: red;&quot;&gt;[&#123;&#123;error&#125;&#125;]&lt;/span&gt;</div><div class="line">        &#123;% endfor %&#125;&lt;br&gt;</div><div class="line">        |&#123;% for pr in providers %&#125;</div><div class="line">        &lt;a href=&quot;javascript:set_openid(&apos;&#123;&#123;pr.url&#125;&#125;&apos;, &apos;&#123;&#123;pr.name&#125;&#125;&apos;);&quot;&gt;&#123;&#123;pr.name&#125;&#125;&lt;/a&gt; |</div><div class="line">        &#123;% endfor %&#125;</div><div class="line">    &lt;/p&gt;</div><div class="line">    &lt;p&gt;&#123;&#123;form.remember_me&#125;&#125; Remember Me&lt;/p&gt;</div><div class="line">    &lt;p&gt;&lt;input type=&quot;submit&quot; value=&quot;Sign In&quot;&gt;&lt;/p&gt;</div><div class="line">&lt;/form&gt;</div><div class="line">&#123;% endblock %&#125;</div></pre></td></tr></table></figure></p>
<p>这次的模板添加的东西似乎有点多。一些公共账号需要提供用户名，为了解决这个我们用了点 javascript。当用户点击相关的公共账号链接时，需要用户名的公共账号会提示用户输入用户名， javascript 会把用户名处理成可用的公共账号，最后再插入到 openid 字段的文本框中。</p>

      
    </div>

    <div>
      
        

      
    </div>

    <div>
      
        
  <div style="padding: 10px 0; margin: 20px auto; width: 90%; text-align: center;">
    <div>坚持原创技术分享，您的支持将鼓励我继续创作！</div>
    <button id="rewardButton" disable="enable" onclick="var qr = document.getElementById('QR'); if (qr.style.display === 'none') {qr.style.display='block';} else {qr.style.display='none'}">
      <span>赏</span>
    </button>
    <div id="QR" style="display: none;">
      
        <div id="wechat" style="display: inline-block">
          <img id="wechat_qr" src="/images/wechatpay01.jpg" alt="发条橙子 WeChat Pay"/>
          <p>微信打赏</p>
        </div>
      
      
    </div>
  </div>


      
    </div>

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/Flask/" rel="tag">#Flask</a>
          
            <a href="/tags/Python/" rel="tag">#Python</a>
          
        </div>
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/flask_2.html" rel="next" title="Flask：模板">
                <i class="fa fa-chevron-left"></i> Flask：模板
              </a>
            
          </div>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/flask_4.html" rel="prev" title="Flask：数据库">
                Flask：数据库 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          
  <div class="comments" id="comments">
    
      <div class="ds-thread" data-thread-key="flask_3.html"
           data-title="Flask：Web表单" data-url="http://www.fatiao.site/flask_3.html">
      </div>
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap" >
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel ">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/images/avatar.jpg"
               alt="发条橙子" />
          <p class="site-author-name" itemprop="name">发条橙子</p>
          <p class="site-description motion-element" itemprop="description">不积跬步，无以至千里</p>
        </div>
        <nav class="site-state motion-element">
          <div class="site-state-item site-state-posts">
            <a href="/archives">
              <span class="site-state-item-count">153</span>
              <span class="site-state-item-name">日志</span>
            </a>
          </div>

          
            <div class="site-state-item site-state-categories">
              <a href="/categories">
                <span class="site-state-item-count">13</span>
                <span class="site-state-item-name">分类</span>
              </a>
            </div>
          

          
            <div class="site-state-item site-state-tags">
              <a href="/tags">
                <span class="site-state-item-count">33</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
        </div>

        
        

        
        

      </section>

      
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">
            
              
            
            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#配置"><span class="nav-number">1.</span> <span class="nav-text">配置</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#用户登录表单"><span class="nav-number">2.</span> <span class="nav-text">用户登录表单</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#表单模板"><span class="nav-number">3.</span> <span class="nav-text">表单模板</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#表单视图"><span class="nav-number">4.</span> <span class="nav-text">表单视图</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#从表单中接收数据"><span class="nav-number">5.</span> <span class="nav-text">从表单中接收数据</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#改善一下字段验证"><span class="nav-number">6.</span> <span class="nav-text">改善一下字段验证</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#处理-OpenID-登录"><span class="nav-number">7.</span> <span class="nav-text">处理 OpenID 登录</span></a></li></ol></div>
            
          </div>
        </section>
      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy;  2009 - 
  <span itemprop="copyrightYear">2016</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">发条橙子</span>
</div>

<!--
<div class="powered-by">
  由 <a class="theme-link" href="https://hexo.io">Hexo</a> 强力驱动
</div>


<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Pisces
  </a>
</div>
-->
        

        
      </div>
    </footer>

    <div class="back-to-top">
      <i class="fa fa-arrow-up"></i>
    </div>
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  



  
  <script type="text/javascript" src="//cdn.bootcss.com/jquery/2.1.3/jquery.min.js"></script>

  
  <script type="text/javascript" src="//cdn.bootcss.com/fastclick/1.0.6/fastclick.min.js"></script>

  
  <script type="text/javascript" src="//cdn.bootcss.com/jquery_lazyload/1.9.7/jquery.lazyload.min.js"></script>

  
  <script type="text/javascript" src="//cdn.bootcss.com/velocity/1.2.1/velocity.min.js"></script>

  
  <script type="text/javascript" src="//cdn.bootcss.com/velocity/1.2.1/velocity.ui.min.js"></script>

  
  <script type="text/javascript" src="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.pack.js"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.0.1"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.0.1"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.0.1"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.0.1"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.0.1"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.0.1"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.0.1"></script>



  

  
    
  

  <script type="text/javascript">
    var duoshuoQuery = {short_name:"ftcz"};
    (function() {
      var ds = document.createElement('script');
      ds.type = 'text/javascript';ds.async = true;
      ds.id = 'duoshuo-script';
      ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
      ds.charset = 'UTF-8';
      (document.getElementsByTagName('head')[0]
      || document.getElementsByTagName('body')[0]).appendChild(ds);
    })();
  </script>

  






  
  

  

  

  

</body>
</html>
